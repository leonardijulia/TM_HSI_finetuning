
seed_everything: 42
experiment_name: hyperview_1_hpo
run_name: optimization_run_v1

# 1. GLOBAL DEFAULTS (Fixed settings applied to all trials)
defaults:
  trainer_args:
    precision: 16-mixed
    max_epochs: 50 # Reduced from 400 for the HPO stage
    accelerator: auto
    devices: auto
    strategy: auto
    # We use a lower patience here to kill bad trials faster
    early_stop_patience: 20
  # Model Configuration
  terratorch_task:
    # Mapping your generic model args here
    model_factory: EncoderDecoderFactory
    model_args:
      backbone: terramind_v1_base
      backbone_ckpt_path: /leonardo/home/userexternal/jleonard/experiments/src/ckpt/TerraMind_v1_base.pt
      backbone_img_size: 224
      backbone_in_chans: 13
      backbone_modalities:
        - S2L2A
      backbone_bands:
        S2L2A: ["COASTAL_AEROSOL", "BLUE", "GREEN", "RED", "RED_EDGE_1", "RED_EDGE_2", "RED_EDGE_3", "NIR_BROAD", "NIR_NARROW", "WATER_VAPOR", "SWIR_1", "SWIR_2", "MASK"]
      necks:
        - name: SelectIndices
          indices: [-1]
        - name: PermuteDims
          new_order: [0,2,1] 
      freeze_backbone: false
      freeze_decoder: false
    num_outputs: 4
    optimizer: AdamW 

# 2. TASK DEFINITION (Your Model and Data setup)
tasks:
  - name: hyperview_regression
    type: regression
    direction: min
    metric: val/loss 
    loss: mse
    model_args:
      decoder: IdentityDecoder
      head_num_outputs: 4
      num_outputs: 4
    datamodule:
      class_path: src.datamodules.hyperview_1.Hyperview1NonGeoDataModule
      init_args:
        num_workers: 2
        bands: s2l2a
        data_root: /leonardo/home/userexternal/jleonard/experiments/data/hyperview_1/
        # batch_size is defined in optimization_space, so it's optional here, 
        # but good to keep a default.
        batch_size: 32 

# 3. HPO CONFIGURATION
n_trials: 25 # Total number of trials to run (adjust as needed)
save_models: False # Usually False during HPO to save space, unless you want the best one
storage_uri: /leonardo/home/userexternal/jleonard/experiments/outputs/hpo_results/
ray_storage_path: /leonardo/home/userexternal/jleonard/experiments/outputs/ray_storage/

# 4. SEARCH SPACE
optimization_space:
  # Data Params
  batch_size:
    - 32
    - 64
  
  # Optimizer Params (Top level LR usually maps to optimizer LR)
  lr:
    - 5e-5
    - 1e-4
    - 2e-4
  
  optimizer_hparams:
    weight_decay:
      - 0.01
      - 0.03
      - 0.05

  # Architecture Params
  model_args:
    head_dropout:
      - 0.2
      - 0.3
      - 0.4
    head_linear_after_pool:
      - true
      - false
    head_dim_list:
      - null         # Represents None (no hidden layers in head)
      - [256]        # One hidden layer
